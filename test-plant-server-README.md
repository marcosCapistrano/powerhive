# Test Power Plant API Server

A Flask-based test server that simulates the power plant API for development and testing of PowerHive automation.

## Features

- **Generation Simulation**: Uses random walk algorithm to fluctuate generation values within configurable bounds
- **External Consumption Control**: Receives expected consumption values from PowerHive via POST endpoint
- **Realistic Data**: Splits generation and consumption across multiple sources matching production API format
- **Authentication**: Bearer token authentication for `/data/latest` endpoint

## Installation

```bash
pip install flask
```

## Usage

### Basic Usage

```bash
python test-plant-server.py --gen-min 0.1 --gen-max 0.5
```

This starts the server with:
- Generation fluctuating between 0.1 and 0.5 MW (100-500 kW)
- Consumption set to 0 MW initially (awaiting POST from PowerHive)
- Server running on port 8090

### Command-Line Options

| Option | Type | Required | Default | Description |
|--------|------|----------|---------|-------------|
| `--gen-min` | float | Yes | - | Minimum generation in MW |
| `--gen-max` | float | Yes | - | Maximum generation in MW |
| `--step` | float | No | 0.01 | Maximum change per update (MW) |
| `--interval` | int | No | 10 | Update interval in seconds |
| `--port` | int | No | 8090 | HTTP server port |
| `--token` | string | No | (matches config.json) | Bearer token for authentication |
| `--debug` | flag | No | false | Enable debug logging |

### Examples

**Small scale test (50-150 kW generation)**
```bash
python test-plant-server.py --gen-min 0.05 --gen-max 0.15
```

**Medium scale test (500-1500 kW generation)**
```bash
python test-plant-server.py --gen-min 0.5 --gen-max 1.5
```

**Custom fluctuation rate**
```bash
python test-plant-server.py --gen-min 0.1 --gen-max 0.5 --step 0.02 --interval 5
```

## API Endpoints

### GET /data/latest

Returns current power plant reading in the same format as production API.

**Authentication**: Required (Bearer token)

**Query Parameters**:
- `plant_id` (required): Must be `complexo-paranhos`

**Example Request**:
```bash
curl -H "Authorization: Bearer YOUR_TOKEN" \
  "http://localhost:8090/data/latest?plant_id=complexo-paranhos"
```

**Response Format**:
```json
{
  "reading": {
    "collection_timestamp": "2025-01-12T10:30:00Z",
    "consumption": {
      "container_eles": {"value_mw": 0.045, "status": "success"},
      "container_mazp": {"value_mw": 0.055, "status": "success"}
    },
    "generation": {
      "generoso": {"value_mw": 0.24, "status": "success"},
      "nogueira": {"value_mw": 0.26, "status": "success"}
    },
    "totals": {
      "consumption_mw": 0.1,
      "generation_mw": 0.5,
      "exported_mw": 0.4
    }
  }
}
```

### POST /data/consumption

Sets the expected consumption value from PowerHive automation.

**Authentication**: Not required (test server only)

**Request Body**:
```json
{
  "expected_consumption_mw": 0.15
}
```

**Example Request**:
```bash
curl -X POST http://localhost:8090/data/consumption \
  -H "Content-Type: application/json" \
  -d '{"expected_consumption_mw": 0.15}'
```

**Response**:
```json
{
  "status": "ok",
  "consumption_mw": 0.15
}
```

### GET /health

Health check endpoint with current server state.

**Authentication**: Not required

**Example Request**:
```bash
curl http://localhost:8090/health
```

**Response**:
```json
{
  "status": "ok",
  "generation_range": [0.1, 0.5],
  "current_generation": 0.32,
  "current_consumption": 0.15,
  "consumption_source": "external"
}
```

## Integration with PowerHive

When running PowerHive with the `--test` flag:

1. PowerHive calculates expected consumption from managed miners' preset changes
2. Sends POST request to `/data/consumption` with the expected value in MW
3. Test server uses this value for the consumption field in `/data/latest` responses
4. PowerHive's power balancer reads this data and adjusts miners accordingly

**Example PowerHive Command**:
```bash
./automation --test --test-server-url http://localhost:8090
```

## Notes

- All power values are in **MW (megawatts)**. 1 MW = 1000 kW.
- Consumption is **not** generated by random walk - it must be set via POST endpoint
- Generation fluctuates automatically using random walk within configured bounds
- Consumption is split 45-55% between two container sources
- Generation is split 48-52% between two generation sources
- The server maintains state until consumption is updated via POST

## Troubleshooting

**Server returns 401 Unauthorized**:
- Check that the Bearer token matches between test server and PowerHive config
- Default token is: `7ab39eed3b05b7e4efc17285bb416304256979967ec8d6ad2b2ef3bc10c0f5ed`

**Consumption always shows 0**:
- Consumption must be set via POST `/data/consumption` endpoint
- Check that PowerHive is running with `--test` flag
- Verify test server URL in PowerHive configuration

**Generation not fluctuating**:
- Check `--interval` setting (default is 10 seconds)
- Verify `--step` is not too small (default is 0.01 MW)
- Enable `--debug` flag to see update logs
